{% extends 'base.html' %}
{% block content %}
	<div class="row">
		<div class="col-lg-8">
			<div class="card shadow-sm mb-3">
				<div class="card-body">
					<div class="d-flex justify-content-between align-items-center">
						<h5 class="card-title mb-0">Results</h5>
						<a href="{{ url_for('index') }}" class="btn btn-outline-light btn-sm">← Back</a>
					</div>
					<div class="text-muted small">Generated at {{ timestamp }}</div>
					<hr />
					<div class="mb-2"><strong>Resolved Domain:</strong> {{ results.resolved_domain or 'n/a' }}</div>
					{% if results.mx %}
						<h6>MX Records</h6>
						{% if results.mx.error %}
							<div class="alert alert-warning">{{ results.mx.error }}</div>
						{% else %}
							{% if results.mx.mx_records and results.mx.mx_records|length > 0 %}
							<ul class="list-group list-group-flush">
							{% for mx in results.mx.mx_records %}
								<li class="list-group-item d-flex justify-content-between align-items-center">
									<span>{{ mx.exchange }}</span>
									<span class="badge rounded-pill text-bg-secondary">Pref {{ mx.preference }}</span>
								</li>
							{% endfor %}
							</ul>
							{% else %}
							<div class="alert alert-info">No MX records found.</div>
							{% endif %}
							<div class="mt-2">Provider: <span class="badge bg-info text-dark">{{ results.mx.provider }}</span></div>
							{% if results.mx.warnings and results.mx.warnings|length %}
								<div class="mt-2">
									{% for w in results.mx.warnings %}
										<div class="small text-warning">⚠️ {{ w }}</div>
									{% endfor %}
								</div>
							{% endif %}
						{% endif %}
					{% endif %}

					{% if results.builtwith %}
						<h6 class="mt-4">BuiltWith</h6>
						{% if results.builtwith.error %}
							<div class="alert alert-warning">{{ results.builtwith.error }}</div>
						{% else %}
							{% if results.builtwith.elapsedMs %}
								<div class="small text-muted mb-2">Elapsed: {{ results.builtwith.elapsedMs }} ms</div>
							{% endif %}
							{% if results.builtwith.grouped and results.builtwith.grouped|length %}
								<ul class="list-group list-group-flush">
								{% for g in results.builtwith.grouped %}
									<li class="list-group-item d-flex justify-content-between align-items-center">
										<div>
											<strong>{{ g.name }}</strong>
											{% if g.categories and g.categories|length %}
												<div class="small text-muted">{{ g.categories | join(', ') }}</div>
											{% endif %}
										</div>
										<span class="badge rounded-pill text-bg-secondary">{{ g.count }}</span>
									</li>
								{% endfor %}
								</ul>
							{% else %}
								<div class="alert alert-info">No BuiltWith data (missing API key or no results).</div>
							{% endif %}
						{% endif %}
					{% endif %}

					{% if results.holehe %}
						<h6 class="mt-4">Holehe</h6>
						{% if results.holehe.error %}
							<div class="alert alert-warning">{{ results.holehe.error }}</div>
						{% else %}
							<div class="small text-muted mb-2">Command: <code>{{ results.holehe.command }}</code>{% if results.holehe.elapsedMs %} · {{ results.holehe.elapsedMs }} ms{% endif %}</div>
							{% if results.holehe.ok and results.holehe.data is defined %}
								<pre class="bg-light p-2 rounded small">{{ results.holehe.data | tojson(indent=2) }}</pre>
							{% elif results.holehe.parsed is defined and results.holehe.parsed %}
								<div class="row">
									<div class="col-md-4">
										<div class="fw-semibold mb-1">Matches [+]</div>
										<ul class="list-group list-group-flush">
										{% for item in results.holehe.parsed.positive %}
											<li class="list-group-item d-flex justify-content-between align-items-center">
												<span>{{ item.site }}</span>
												{% if item.loginBehind %}<span class="badge text-bg-warning">login</span>{% endif %}
											</li>
										{% endfor %}
										</ul>
									</div>

									<div class="col-md-4">
										<div class="fw-semibold mb-1">No Match [-]</div>
										<ul class="list-group list-group-flush">
										{% for item in results.holehe.parsed.negative %}
											<li class="list-group-item d-flex justify-content-between align-items-center">
												<span>{{ item.site }}</span>
												{% if item.loginBehind %}<span class="badge text-bg-warning">login</span>{% endif %}
											</li>
										{% endfor %}
										</ul>
									</div>

									<div class="col-md-4">
										<div class="fw-semibold mb-1">Unknown [x]</div>
										<ul class="list-group list-group-flush">
										{% for item in results.holehe.parsed.unknown %}
											<li class="list-group-item d-flex justify-content-between align-items-center">
												<span>{{ item.site }}</span>
												{% if item.loginBehind %}<span class="badge text-bg-warning">login</span>{% endif %}
											</li>
										{% endfor %}
										</ul>
									</div>
								</div>
								<details class="mt-2"><summary class="small">Raw</summary><pre class="bg-light p-2 rounded small">{{ results.holehe.stdout }}</pre></details>
							{% elif results.holehe.stdout is defined %}
								<pre class="bg-light p-2 rounded small">{{ results.holehe.stdout }}</pre>
								{% if results.holehe.stderr is defined and results.holehe.stderr %}
									<details class="mt-2"><summary class="small">stderr</summary><pre class="bg-light p-2 rounded small">{{ results.holehe.stderr }}</pre></details>
								{% endif %}
							{% else %}
								<div class="alert alert-info">No Holehe output.</div>
							{% endif %}
						{% endif %}
					{% endif %}

					{% if results.pattern_holehe and results.pattern_holehe.results %}
						<h6 class="mt-4">Pattern Candidates (Holehe)</h6>
						<div class="row">
							{% for item in results.pattern_holehe.results %}
								<div class="col-md-6 mb-2">
									<div class="border rounded p-2 h-100">
										<div class="fw-semibold">{{ item.email }}</div>
										{% if item.holehe and item.holehe.parsed %}
											<div class="small text-muted">+
												{{ item.holehe.parsed.totals.positive }} / - {{ item.holehe.parsed.totals.negative }} / x {{ item.holehe.parsed.totals.unknown }}
											</div>
											{% if item.holehe.parsed.positive and item.holehe.parsed.positive|length %}
												<div class="small">Matches: {{ item.holehe.parsed.positive | map(attribute='site') | list | join(', ') }}</div>
											{% endif %}
											{% if item.holehe.stdout %}
												<details class="small"><summary>Raw</summary><pre class="bg-light p-2 rounded small">{{ item.holehe.stdout }}</pre></details>
											{% endif %}
											{% if item.holehe.stderr %}
												<details class="mt-2 small"><summary>stderr</summary><pre class="bg-light p-2 rounded small">{{ item.holehe.stderr }}</pre></details>
											{% endif %}
										{% elif item.holehe and item.holehe.ok and item.holehe.data %}
											<pre class="bg-light p-2 rounded small">{{ item.holehe.data | tojson(indent=2) }}</pre>
										{% elif item.holehe and item.holehe.stdout %}
											<details class="small"><summary>Raw</summary><pre class="bg-light p-2 rounded small">{{ item.holehe.stdout }}</pre></details>
											{% if item.holehe.stderr %}
												<details class="mt-2 small"><summary>stderr</summary><pre class="bg-light p-2 rounded small">{{ item.holehe.stderr }}</pre></details>
											{% endif %}
										{% else %}
											<div class="small text-muted">No output</div>
										{% endif %}
									</div>
								</div>
							{% endfor %}
						</div>
					{% endif %}

					{# Email pattern bölümü kaldırıldı #}
				</div>
			</div>
		</div>
		<div class="col-lg-4">
			<div class="card shadow-sm mb-3">
				<div class="card-body">
					<h6 class="card-title">Training Email (Awareness)</h6>
					<div class="mb-2"><strong>From:</strong> <span class="font-monospace">{{ results.training_email.from }}</span></div>
					{% if results.training_email.to_example %}
						<div class="mb-2"><strong>To (example):</strong> <span class="font-monospace">{{ results.training_email.to_example }}</span></div>
					{% endif %}
					<div class="mb-2"><strong>Subject:</strong> {{ results.training_email.subject }}</div>
					<details class="mb-2" open>
						<div class="d-flex justify-content-between align-items-center">
							<summary class="mb-0">Preview</summary>
							<button class="btn btn-outline-light btn-sm copy-btn" data-copy-target="#training-body-pre">Copy</button>
						</div>
						<pre id="training-body-pre" class="p-2 rounded small">{{ results.training_email.body_text }}</pre>
					</details>
					{% if results.training_email.notes and results.training_email.notes.context %}
						<div class="small text-muted">{{ results.training_email.notes.context }}</div>
					{% endif %}
					{% if results.mailbox_probe %}
						<div class="mt-3">
							<div class="fw-semibold">Mailbox Probe</div>
							<pre class="p-2 rounded small">{{ results.mailbox_probe | tojson(indent=2) }}</pre>
							{% if results.mailbox_probe.trace %}
								<details class="mt-2"><summary class="small">Probe Trace</summary><pre class="bg-light p-2 rounded small">{{ results.mailbox_probe.trace | tojson(indent=2) }}</pre></details>
							{% endif %}
						</div>
					{% endif %}
					{% if results.mail_send %}
						<div class="mt-3">
							<div class="fw-semibold">Mail Send</div>
							<pre class="p-2 rounded small">{{ results.mail_send | tojson(indent=2) }}</pre>
						</div>
					{% endif %}
				</div>
			</div>
			<details class="mb-2">
  <summary>Preview (HTML)</summary>
  <div class="d-flex justify-content-between align-items-center mb-1">
    <div class="small text-muted">HTML preview</div>
    <button class="btn btn-outline-light btn-sm copy-btn" data-copy-target="#training-body-html-pre">Copy</button>
  </div>
  <div class="p-2 rounded small bg-light text-dark">
    <pre id="training-body-html-pre" class="p-0 m-0 bg-transparent border-0">{% if results.training_email.body_html %}{{ results.training_email.body_html | safe }}{% else %}<em>No HTML body</em>{% endif %}</pre>
  </div>
</details>
			<div class="card shadow-sm mb-3">
				<div class="card-body">
					<div class="d-flex justify-content-between align-items-center">
						<h6 class="card-title mb-0">Raw JSON</h6>
						<button class="btn btn-outline-light btn-sm copy-btn" data-copy-target="#raw-json-pre">Copy</button>
					</div>
					<pre id="raw-json-pre" class="bg-light p-2 rounded small">{{ results | tojson(indent=2) }}</pre>
				</div>
			</div>
		</div>
	</div>
{% endblock %}